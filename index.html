<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvolutionBob - Ecosystem Evolution Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tooltip {
            display: none;
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 100;
            white-space: pre;
        }
        .details-arrow {
            transition: transform 0.3s ease-in-out;
        }
        details[open] .details-arrow {
            transform: rotate(90deg);
        }
        /* Custom scrollbar for the settings panel */
        .settings-panel::-webkit-scrollbar {
            width: 8px;
        }
        .settings-panel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .settings-panel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        .settings-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-screen p-4">

    <div class="w-full max-w-7xl mx-auto flex flex-col lg:flex-row gap-4">
        <!-- Main Simulation Area -->
        <div class="flex-grow flex flex-col items-center justify-center">
            <img src="https://kokanp.github.io/EvolutionBob/img/EvolutionBobLogo.webp" alt="EvolutionBob Logo" class="w-48 h-48 mb-2">
            <h1 class="text-lg font-light mb-4 text-teal-300">A Life Sim for Simple People</h1>
            <div class="relative bg-gray-800 border-4 border-teal-400 rounded-lg shadow-2xl" id="canvas-container">
                <canvas id="ecosystemCanvas"></canvas>
                <div id="tooltip" class="tooltip"></div>
            </div>
        </div>

        <!-- Controls and Info Panel -->
        <div class="lg:w-96 flex-shrink-0 space-y-4 overflow-y-auto settings-panel" style="max-height: 95vh;">
            <div class="glass-panel p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-3 text-teal-300">Controls</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <button id="startStopBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Start</button>
                        <button id="resetBtn" class="ml-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Reset All</button>
                    </div>
                     <div>
                        <label for="speedSlider" class="block mb-1 text-sm font-medium">Simulation Speed</label>
                        <input id="speedSlider" type="range" min="1" max="1000" value="100" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="gridSizeSlider" class="block mb-1 text-sm font-medium">Grid Size: <span id="gridSizeLabel">50</span>x<span id="gridSizeLabel2">50</span></label>
                        <input id="gridSizeSlider" type="range" min="50" max="250" value="50" step="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="flex justify-between items-center space-x-2">
                        <button id="copySettingsBtn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Copy Settings</button>
                        <button id="saveSettingsBtn" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Save Settings</button>
                    </div>
                    <div>
                        <button id="importSettingsBtn" class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Import Settings</button>
                        <input type="file" id="settingsFileInput" class="hidden" accept=".txt">
                    </div>
                     <button id="copyResultBtn" class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 hidden">Copy Result</button>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-teal-300">Initial Population</h2>
                    <button id="resetPopulationBtn" title="Reset population to defaults">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white transition-colors"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 4m.5 4v-4h-4"/></svg>
                    </button>
                </div>
                <div class="space-y-3">
                    <div>
                        <label for="plantSlider" class="block mb-1 text-sm font-medium">Plants (<span id="plantPercentLabel">10</span>%)</label>
                        <input id="plantSlider" type="range" min="1" max="50" value="10" class="w-full h-2 bg-green-500 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="herbivoreSlider" class="block mb-1 text-sm font-medium">Herbivores (<span id="herbivorePercentLabel">5</span>%)</label>
                        <input id="herbivoreSlider" type="range" min="1" max="20" value="5" class="w-full h-2 bg-blue-500 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="carnivoreSlider" class="block mb-1 text-sm font-medium">Carnivores (<span id="carnivorePercentLabel">1</span>%)</label>
                        <input id="carnivoreSlider" type="range" min="1" max="10" value="1" class="w-full h-2 bg-red-500 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="omnivoreSlider" class="block mb-1 text-sm font-medium">Omnivores (<span id="omnivorePercentLabel">2</span>%)</label>
                        <input id="omnivoreSlider" type="range" min="1" max="15" value="2" class="w-full h-2 bg-purple-500 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>

            <!-- Advanced Parameters -->
            <div class="glass-panel rounded-lg shadow-lg">
                <details id="advanced-settings-details" class="p-4">
                    <summary class="flex justify-between items-center cursor-pointer">
                        <h2 class="text-xl font-semibold text-teal-300">Advanced Parameters</h2>
                        <svg class="details-arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </summary>
                    <div class="mt-4 space-y-4">
                        <!-- Plant Settings -->
                        <div class="border-t border-gray-600 pt-4">
                            <h3 class="font-semibold text-green-400 mb-2">Plant Settings</h3>
                            <label class="block text-sm">Max Energy: <span id="plantMaxEnergyLabel"></span></label>
                            <input id="plantMaxEnergy" type="range" min="50" max="200" value="100" step="10">
                            <label class="block text-sm mt-2">Reproduction Energy Cost: <span id="plantReproduceCostLabel"></span></label>
                            <input id="plantReproduceCost" type="range" min="5" max="50" value="25" step="5">
                            <label class="block text-sm mt-2">Reproduction Chance: <span id="plantReproduceChanceLabel"></span>%</label>
                            <input id="plantReproduceChance" type="range" min="1" max="50" value="5">
                            <label class="block text-sm mt-2">Energy Gain: <span id="plantEnergyGainLabel"></span></label>
                            <input id="plantEnergyGain" type="range" min="0.1" max="5" value="0.5" step="0.1">
                        </div>
                        <!-- Herbivore Settings -->
                        <div class="border-t border-gray-600 pt-4">
                            <h3 class="font-semibold text-blue-400 mb-2">Herbivore Settings</h3>
                            <label class="block text-sm">Max Energy: <span id="herbivoreMaxEnergyLabel"></span></label>
                            <input id="herbivoreMaxEnergy" type="range" min="50" max="500" value="200" step="10">
                            <label class="block text-sm mt-2">Reproduction Energy: <span id="herbivoreReproduceEnergyLabel"></span></label>
                            <input id="herbivoreReproduceEnergy" type="range" min="50" max="400" value="150" step="10">
                            <label class="block text-sm mt-2">Reproduction Energy Cost: <span id="herbivoreReproduceCostLabel"></span></label>
                            <input id="herbivoreReproduceCost" type="range" min="25" max="200" value="75" step="5">
                             <label class="block text-sm mt-2">Energy Decay: <span id="herbivoreEnergyDecayLabel"></span></label>
                            <input id="herbivoreEnergyDecay" type="range" min="0.1" max="10" value="1" step="0.1">
                            <label class="block text-sm mt-2">Max Age: <span id="herbivoreMaxAgeLabel"></span></label>
                            <input id="herbivoreMaxAge" type="range" min="50" max="500" value="200" step="10">
                        </div>
                        <!-- Carnivore Settings -->
                        <div class="border-t border-gray-600 pt-4">
                            <h3 class="font-semibold text-red-400 mb-2">Carnivore Settings</h3>
                            <label class="block text-sm">Max Energy: <span id="carnivoreMaxEnergyLabel"></span></label>
                            <input id="carnivoreMaxEnergy" type="range" min="100" max="800" value="300" step="10">
                            <label class="block text-sm mt-2">Reproduction Energy: <span id="carnivoreReproduceEnergyLabel"></span></label>
                            <input id="carnivoreReproduceEnergy" type="range" min="100" max="700" value="250" step="10">
                            <label class="block text-sm mt-2">Reproduction Energy Cost: <span id="carnivoreReproduceCostLabel"></span></label>
                            <input id="carnivoreReproduceCost" type="range" min="50" max="400" value="100" step="10">
                             <label class="block text-sm mt-2">Energy Decay: <span id="carnivoreEnergyDecayLabel"></span></label>
                            <input id="carnivoreEnergyDecay" type="range" min="0.5" max="15" value="2" step="0.1">
                            <label class="block text-sm mt-2">Max Age: <span id="carnivoreMaxAgeLabel"></span></label>
                            <input id="carnivoreMaxAge" type="range" min="100" max="800" value="300" step="10">
                            <label class="block text-sm mt-2">Search Radius: <span id="carnivoreSearchRadiusLabel"></span></label>
                            <input id="carnivoreSearchRadius" type="range" min="1" max="30" value="8">
                            <label class="block text-sm mt-2">Hunger Threshold: <span id="carnivoreHungerThresholdLabel"></span>%</label>
                            <input id="carnivoreHungerThreshold" type="range" min="10" max="90" value="70" step="5">
                             <label class="block text-sm mt-2">Search Cooldown: <span id="carnivoreSearchCooldownLabel"></span> turns</label>
                            <input id="carnivoreSearchCooldown" type="range" min="0" max="10" value="3">
                            <label class="block text-sm mt-2">Combat Bonus: <span id="carnivoreCombatBonusLabel"></span>%</label>
                            <input id="carnivoreCombatBonus" type="range" min="0" max="100" value="20" step="5">
                        </div>
                        <!-- Omnivore Settings -->
                        <div class="border-t border-gray-600 pt-4">
                            <h3 class="font-semibold text-purple-400 mb-2">Omnivore Settings</h3>
                            <label class="block text-sm">Max Energy: <span id="omnivoreMaxEnergyLabel"></span></label>
                            <input id="omnivoreMaxEnergy" type="range" min="100" max="700" value="250" step="10">
                            <label class="block text-sm mt-2">Reproduction Energy: <span id="omnivoreReproduceEnergyLabel"></span></label>
                            <input id="omnivoreReproduceEnergy" type="range" min="100" max="600" value="200" step="10">
                            <label class="block text-sm mt-2">Reproduction Energy Cost: <span id="omnivoreReproduceCostLabel"></span></label>
                            <input id="omnivoreReproduceCost" type="range" min="50" max="350" value="90" step="10">
                             <label class="block text-sm mt-2">Energy Decay: <span id="omnivoreEnergyDecayLabel"></span></label>
                            <input id="omnivoreEnergyDecay" type="range" min="0.5" max="12" value="1.5" step="0.1">
                            <label class="block text-sm mt-2">Max Age: <span id="omnivoreMaxAgeLabel"></span></label>
                            <input id="omnivoreMaxAge" type="range" min="100" max="700" value="250" step="10">
                             <label class="block text-sm mt-2">Search Radius: <span id="omnivoreSearchRadiusLabel"></span></label>
                            <input id="omnivoreSearchRadius" type="range" min="1" max="30" value="10">
                             <label class="block text-sm mt-2">Hunger Threshold: <span id="omnivoreHungerThresholdLabel"></span>%</label>
                            <input id="omnivoreHungerThreshold" type="range" min="10" max="90" value="70" step="5">
                            <label class="block text-sm mt-2">Search Cooldown: <span id="omnivoreSearchCooldownLabel"></span> turns</label>
                            <input id="omnivoreSearchCooldown" type="range" min="0" max="10" value="5">
                        </div>
                        <button id="resetAdvancedBtn" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Reset Advanced Settings</button>
                    </div>
                </details>
            </div>

            <div class="glass-panel p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-3 text-teal-300">Live Statistics</h2>
                <div id="stats" class="space-y-2 text-sm">
                    <p>Time: <span id="timeStat">0</span></p>
                    <p>Plants: <span id="plantStat">0</span></p>
                    <p>Herbivores: <span id="herbivoreStat">0</span></p>
                    <p>Carnivores: <span id="carnivoreStat">0</span></p>
                    <p>Omnivores: <span id="omnivoreStat">0</span></p>
                </div>
            </div>

            <!-- Population Graph -->
             <div class="glass-panel rounded-lg shadow-lg">
                <details id="population-graph-details" class="p-4" open>
                    <summary class="flex justify-between items-center cursor-pointer">
                        <h2 class="text-xl font-semibold text-teal-300">Population Graph</h2>
                        <svg class="details-arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </summary>
                    <div class="chart-container mt-4">
                        <canvas id="populationChart"></canvas>
                    </div>
                </details>
            </div>

            <div class="text-xs text-gray-500 text-right w-full pr-2" id="version-display">v0.7</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const canvas = document.getElementById('ecosystemCanvas');
            const ctx = canvas.getContext('2d');
            const tooltip = document.getElementById('tooltip');
            const startStopBtn = document.getElementById('startStopBtn');
            const resetBtn = document.getElementById('resetBtn');
            const speedSlider = document.getElementById('speedSlider');
            const gridSizeSlider = document.getElementById('gridSizeSlider');
            const gridSizeLabel = document.getElementById('gridSizeLabel');
            const gridSizeLabel2 = document.getElementById('gridSizeLabel2');
            const plantSlider = document.getElementById('plantSlider');
            const herbivoreSlider = document.getElementById('herbivoreSlider');
            const carnivoreSlider = document.getElementById('carnivoreSlider');
            const omnivoreSlider = document.getElementById('omnivoreSlider');
            const plantPercentLabel = document.getElementById('plantPercentLabel');
            const herbivorePercentLabel = document.getElementById('herbivorePercentLabel');
            const carnivorePercentLabel = document.getElementById('carnivorePercentLabel');
            const omnivorePercentLabel = document.getElementById('omnivorePercentLabel');
            const resetPopulationBtn = document.getElementById('resetPopulationBtn');
            const advancedSettingsDetails = document.getElementById('advanced-settings-details');
            const resetAdvancedBtn = document.getElementById('resetAdvancedBtn');
            const copySettingsBtn = document.getElementById('copySettingsBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const importSettingsBtn = document.getElementById('importSettingsBtn');
            const settingsFileInput = document.getElementById('settingsFileInput');
            const copyResultBtn = document.getElementById('copyResultBtn');
            const chartCanvas = document.getElementById('populationChart');
            const chartCtx = chartCanvas.getContext('2d');

            // --- Advanced Settings Elements ---
            const inputs = {
                plant: { maxEnergy: document.getElementById('plantMaxEnergy'), reproduceCost: document.getElementById('plantReproduceCost'), reproduceChance: document.getElementById('plantReproduceChance'), energyGain: document.getElementById('plantEnergyGain'), },
                herbivore: { maxEnergy: document.getElementById('herbivoreMaxEnergy'), reproduceEnergy: document.getElementById('herbivoreReproduceEnergy'), reproduceCost: document.getElementById('herbivoreReproduceCost'), energyDecay: document.getElementById('herbivoreEnergyDecay'), maxAge: document.getElementById('herbivoreMaxAge'), },
                carnivore: { maxEnergy: document.getElementById('carnivoreMaxEnergy'), reproduceEnergy: document.getElementById('carnivoreReproduceEnergy'), reproduceCost: document.getElementById('carnivoreReproduceCost'), energyDecay: document.getElementById('carnivoreEnergyDecay'), maxAge: document.getElementById('carnivoreMaxAge'), searchRadius: document.getElementById('carnivoreSearchRadius'), hungerThreshold: document.getElementById('carnivoreHungerThreshold'), searchCooldown: document.getElementById('carnivoreSearchCooldown'), combatBonus: document.getElementById('carnivoreCombatBonus'), },
                omnivore: { maxEnergy: document.getElementById('omnivoreMaxEnergy'), reproduceEnergy: document.getElementById('omnivoreReproduceEnergy'), reproduceCost: document.getElementById('omnivoreReproduceCost'), energyDecay: document.getElementById('omnivoreEnergyDecay'), maxAge: document.getElementById('omnivoreMaxAge'), searchRadius: document.getElementById('omnivoreSearchRadius'), hungerThreshold: document.getElementById('omnivoreHungerThreshold'), searchCooldown: document.getElementById('omnivoreSearchCooldown'), }
            };
            const labels = {
                plant: { maxEnergy: document.getElementById('plantMaxEnergyLabel'), reproduceCost: document.getElementById('plantReproduceCostLabel'), reproduceChance: document.getElementById('plantReproduceChanceLabel'), energyGain: document.getElementById('plantEnergyGainLabel'), },
                herbivore: { maxEnergy: document.getElementById('herbivoreMaxEnergyLabel'), reproduceEnergy: document.getElementById('herbivoreReproduceEnergyLabel'), reproduceCost: document.getElementById('herbivoreReproduceCostLabel'), energyDecay: document.getElementById('herbivoreEnergyDecayLabel'), maxAge: document.getElementById('herbivoreMaxAgeLabel'), },
                carnivore: { maxEnergy: document.getElementById('carnivoreMaxEnergyLabel'), reproduceEnergy: document.getElementById('carnivoreReproduceEnergyLabel'), reproduceCost: document.getElementById('carnivoreReproduceCostLabel'), energyDecay: document.getElementById('carnivoreEnergyDecayLabel'), maxAge: document.getElementById('carnivoreMaxAgeLabel'), searchRadius: document.getElementById('carnivoreSearchRadiusLabel'), hungerThreshold: document.getElementById('carnivoreHungerThresholdLabel'), searchCooldown: document.getElementById('carnivoreSearchCooldownLabel'), combatBonus: document.getElementById('carnivoreCombatBonusLabel'), },
                omnivore: { maxEnergy: document.getElementById('omnivoreMaxEnergyLabel'), reproduceEnergy: document.getElementById('omnivoreReproduceEnergyLabel'), reproduceCost: document.getElementById('omnivoreReproduceCostLabel'), energyDecay: document.getElementById('omnivoreEnergyDecayLabel'), maxAge: document.getElementById('omnivoreMaxAgeLabel'), searchRadius: document.getElementById('omnivoreSearchRadiusLabel'), hungerThreshold: document.getElementById('omnivoreHungerThresholdLabel'), searchCooldown: document.getElementById('omnivoreSearchCooldownLabel'), }
            };

            // --- Config Object ---
            let config = {};

            function setDefaultConfig() {
                config = {
                    plant: { maxEnergy: 100, reproduceCost: 25, reproduceChance: 0.05, energyGain: 0.5 },
                    herbivore: { maxEnergy: 200, reproduceEnergy: 150, reproduceCost: 75, energyDecay: 1, maxAge: 200 },
                    carnivore: { maxEnergy: 300, reproduceEnergy: 250, reproduceCost: 100, energyDecay: 2, maxAge: 300, searchRadius: 8, hungerThreshold: 0.7, searchCooldown: 3, combatBonus: 1.2 },
                    omnivore: { maxEnergy: 250, reproduceEnergy: 200, reproduceCost: 90, energyDecay: 1.5, maxAge: 250, searchRadius: 10, hungerThreshold: 0.7, searchCooldown: 5 }
                };
                updateAdvancedSettingsUI();
            }

            function updateAdvancedSettingsUI() {
                for (const species in config) {
                    for (const param in config[species]) {
                        let value = config[species][param];
                        if (param === 'reproduceChance' || param === 'hungerThreshold') value *= 100;
                        if (param === 'combatBonus') value = (value - 1) * 100;
                        inputs[species][param].value = value;
                    }
                }
                updateAdvancedLabels();
            }
            
            function updateAdvancedLabels() {
                for (const species in labels) {
                    for (const param in labels[species]) {
                        const input = inputs[species][param];
                        const label = labels[species][param];
                        let value = parseFloat(input.value);
                        if (param === 'energyGain' || param === 'energyDecay') {
                            label.textContent = value.toFixed(1);
                        } else {
                            label.textContent = value.toFixed(0);
                        }
                    }
                }
            }

            // --- Simulation Parameters ---
            let gridSize = 50;
            let canvasSize = Math.min(window.innerWidth * 0.6, window.innerHeight * 0.8, 800);
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            let cellSize = canvas.width / gridSize;

            // --- Simulation State ---
            let simulationRunning = false;
            let organisms = [];
            let spatialGrid = [];
            let time = 0;
            let simulationInterval;
            let speed = 100;
            
            // --- Chart State ---
            let populationChart;
            let timeHistory, plantHistory, herbivoreHistory, carnivoreHistory, omnivoreHistory;
            const chartUpdateFrequency = 10;

            // --- Base Organism Class ---
            class Organism {
                constructor(x, y, energy) { this.id = Math.random().toString(36).substr(2, 9); this.x = x; this.y = y; this.energy = energy; this.age = 0; }
                update() { this.age++; }
                draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x * cellSize + cellSize / 2, this.y * cellSize + cellSize / 2, cellSize / 2.5, 0, 2 * Math.PI); ctx.fill(); }
                die() { organisms = organisms.filter(org => org.id !== this.id); }
            }

            // --- Species Classes ---
            class Plant extends Organism {
                constructor(x, y) {
                    super(x, y, 20);
                    this.color = '#4ade80';
                    Object.assign(this, config.plant);
                }
                update() {
                    super.update();
                    this.energy = Math.min(this.maxEnergy, this.energy + this.energyGain);
                    if (Math.random() < this.reproduceChance && this.energy > this.reproduceCost) this.reproduce();
                }
                reproduce() {
                    const emptyNeighbors = [];
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            const newX = (this.x + dx + gridSize) % gridSize, newY = (this.y + dy + gridSize) % gridSize;
                            if (!isOccupied(newX, newY)) emptyNeighbors.push({x: newX, y: newY});
                        }
                    }
                    if (emptyNeighbors.length > 0) {
                        const spot = emptyNeighbors[Math.floor(Math.random() * emptyNeighbors.length)];
                        this.energy -= this.reproduceCost;
                        organisms.push(new Plant(spot.x, spot.y));
                    }
                }
                getTooltipInfo() { return `Type: Plant\nEnergy: ${this.energy.toFixed(1)}`; }
            }

            class Herbivore extends Organism {
                constructor(x, y) {
                    super(x, y, 100);
                    this.color = '#60a5fa';
                    Object.assign(this, config.herbivore);
                }
                update() {
                    super.update();
                    this.energy -= this.energyDecay;
                    if (!this.eat()) this.move();
                    if (this.energy > this.reproduceEnergy) this.reproduce();
                    if (this.energy <= 0 || this.age > this.maxAge) this.die();
                }
                move() { this.x = (this.x + Math.floor(Math.random() * 3) - 1 + gridSize) % gridSize; this.y = (this.y + Math.floor(Math.random() * 3) - 1 + gridSize) % gridSize; }
                eat() {
                    const cellmates = spatialGrid[this.y][this.x];
                    for (let org of cellmates) { if (org instanceof Plant) { this.energy = Math.min(this.maxEnergy, this.energy + org.energy); org.die(); return true; } }
                    return false;
                }
                reproduce() { this.energy -= this.reproduceCost; organisms.push(new Herbivore(this.x, this.y)); }
                getTooltipInfo() { return `Type: Herbivore\nEnergy: ${this.energy.toFixed(1)}`; }
            }

            class Carnivore extends Organism {
                 constructor(x, y) {
                    super(x, y, 150);
                    this.color = '#f87171';
                    Object.assign(this, config.carnivore);
                    this.currentSearchCooldown = 0;
                }
                update() {
                    super.update();
                    this.energy -= this.energyDecay;
                    if (this.currentSearchCooldown > 0) this.currentSearchCooldown--;

                    if (!this.eat()) this.move();
                    if (this.energy > this.reproduceEnergy) this.reproduce();
                    if (this.energy <= 0 || this.age > this.maxAge) this.die();
                }
                move() {
                    let nearestPrey = null;
                    if (this.energy < this.maxEnergy * this.hungerThreshold && this.currentSearchCooldown <= 0) {
                       nearestPrey = this.findNearestPrey();
                       this.currentSearchCooldown = this.searchCooldown;
                    }
                    if (nearestPrey) {
                        let dx = Math.sign(nearestPrey.x - this.x), dy = Math.sign(nearestPrey.y - this.y);
                        this.x = (this.x + dx + gridSize) % gridSize; this.y = (this.y + dy + gridSize) % gridSize;
                    } else { this.x = (this.x + Math.floor(Math.random() * 3) - 1 + gridSize) % gridSize; this.y = (this.y + Math.floor(Math.random() * 3) - 1 + gridSize) % gridSize; }
                }
                findNearestPrey() {
                    for (let r = 1; r <= this.searchRadius; r++) {
                        for (let dy = -r; dy <= r; dy++) {
                            for (let dx = -r; dx <= r; dx++) {
                                if (Math.abs(dx) !== r && Math.abs(dy) !== r) continue;
                                const cX = (this.x + dx + gridSize) % gridSize, cY = (this.y + dy + gridSize) % gridSize;
                                for (const org of spatialGrid[cY][cX]) { if (org instanceof Herbivore) return org; }
                            }
                        }
                    }
                    return null;
                }
                eat() {
                    for (let org of spatialGrid[this.y][this.x]) { if (org instanceof Herbivore) { this.energy = Math.min(this.maxEnergy, this.energy + org.energy); org.die(); return true; } }
                    return false;
                }
                reproduce() { this.energy -= this.reproduceCost; organisms.push(new Carnivore(this.x, this.y)); }
                getTooltipInfo() { return `Type: Carnivore\nEnergy: ${this.energy.toFixed(1)}`; }
            }
            
            class Omnivore extends Organism {
                constructor(x, y) {
                    super(x, y, 120);
                    this.color = '#a855f7';
                    Object.assign(this, config.omnivore);
                    this.currentSearchCooldown = 0;
                }
                update() {
                    super.update();
                    this.energy -= this.energyDecay;
                    if (this.currentSearchCooldown > 0) this.currentSearchCooldown--;

                    if (!this.eat()) this.move();
                    if (this.energy > this.reproduceEnergy) this.reproduce();
                    if (this.energy <= 0 || this.age > this.maxAge) this.die();
                }
                move() {
                    let nearestFood = null;
                    if (this.energy < this.maxEnergy * this.hungerThreshold && this.currentSearchCooldown <= 0) {
                        nearestFood = this.findFood();
                        this.currentSearchCooldown = this.searchCooldown;
                    }
                    if (nearestFood) {
                        let dx = Math.sign(nearestFood.x - this.x), dy = Math.sign(nearestFood.y - this.y);
                        this.x = (this.x + dx + gridSize) % gridSize; this.y = (this.y + dy + gridSize) % gridSize;
                    } else { this.x = (this.x + Math.floor(Math.random() * 3) - 1 + gridSize) % gridSize; this.y = (this.y + Math.floor(Math.random() * 3) - 1 + gridSize) % gridSize; }
                }
                findFood() {
                    for (let r = 1; r <= this.searchRadius; r++) {
                        for (let dy = -r; dy <= r; dy++) {
                            for (let dx = -r; dx <= r; dx++) {
                                if (Math.abs(dx) !== r && Math.abs(dy) !== r) continue;
                                const cX = (this.x + dx + gridSize) % gridSize, cY = (this.y + dy + gridSize) % gridSize;
                                for (const org of spatialGrid[cY][cX]) { if (org instanceof Herbivore) return org; }
                                for (const org of spatialGrid[cY][cX]) { if (org instanceof Plant) return org; }
                            }
                        }
                    }
                    return null;
                }
                eat() {
                    const cellmates = spatialGrid[this.y][this.x];
                    for (let org of cellmates) { if (org instanceof Herbivore) { this.energy = Math.min(this.maxEnergy, this.energy + org.energy); org.die(); return true; } }
                    for (let org of cellmates) { if (org instanceof Plant) { this.energy = Math.min(this.maxEnergy, this.energy + org.energy); org.die(); return true; } }
                    return false;
                }
                reproduce() { this.energy -= this.reproduceCost; organisms.push(new Omnivore(this.x, this.y)); }
                getTooltipInfo() { return `Type: Omnivore\nEnergy: ${this.energy.toFixed(1)}`; }
            }

            function updateSpatialGrid() {
                spatialGrid = Array(gridSize).fill(null).map(() => Array(gridSize).fill(null).map(() => []));
                for (const org of organisms) { if (org.x >= 0 && org.x < gridSize && org.y >= 0 && org.y < gridSize) spatialGrid[org.y][org.x].push(org); }
            }
            function isOccupied(x, y) { if (x < 0 || x >= gridSize || y < 0 || y >= gridSize) return true; return spatialGrid[y][x].length > 0; }

            function init() {
                time = 0;
                organisms = [];
                const totalCells = gridSize * gridSize;
                const numPlants = Math.floor(totalCells * (parseInt(plantSlider.value) / 100));
                const numHerbivores = Math.floor(totalCells * (parseInt(herbivoreSlider.value) / 100));
                const numCarnivores = Math.floor(totalCells * (parseInt(carnivoreSlider.value) / 100));
                const numOmnivores = Math.floor(totalCells * (parseInt(omnivoreSlider.value) / 100));
                const availableCells = [];
                for (let x = 0; x < gridSize; x++) for (let y = 0; y < gridSize; y++) availableCells.push({x, y});
                for (let i = availableCells.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [availableCells[i], availableCells[j]] = [availableCells[j], availableCells[i]]; }
                const placeOrganisms = (OrganismClass, count) => { for (let i = 0; i < count; i++) { if (availableCells.length === 0) break; const cell = availableCells.pop(); organisms.push(new OrganismClass(cell.x, cell.y)); } };
                placeOrganisms(Plant, numPlants);
                placeOrganisms(Herbivore, numHerbivores);
                placeOrganisms(Carnivore, numCarnivores);
                placeOrganisms(Omnivore, numOmnivores);
                
                initChart();
                updateSpatialGrid();
                draw();
                updateStats();
            }
            
            function initChart() {
                if(populationChart) populationChart.destroy();
                
                timeHistory = [0];
                plantHistory = [organisms.filter(o => o instanceof Plant).length];
                herbivoreHistory = [organisms.filter(o => o instanceof Herbivore).length];
                carnivoreHistory = [organisms.filter(o => o instanceof Carnivore).length];
                omnivoreHistory = [organisms.filter(o => o instanceof Omnivore).length];

                populationChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        labels: timeHistory,
                        datasets: [
                            { label: 'Plants', data: plantHistory, borderColor: '#4ade80', fill: false, tension: 0.1, pointRadius: 0 },
                            { label: 'Herbivores', data: herbivoreHistory, borderColor: '#60a5fa', fill: false, tension: 0.1, pointRadius: 0 },
                            { label: 'Carnivores', data: carnivoreHistory, borderColor: '#f87171', fill: false, tension: 0.1, pointRadius: 0 },
                            { label: 'Omnivores', data: omnivoreHistory, borderColor: '#a855f7', fill: false, tension: 0.1, pointRadius: 0 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' }, beginAtZero: true }
                        },
                        plugins: {
                            legend: { labels: { color: '#d1d5db' } }
                        }
                    }
                });
            }

           function simulationStep() {
    if (!simulationRunning) return;
    updateSpatialGrid();
    const cellsWithFights = new Set();
    for (const org of organisms) {
        if (!(org instanceof Carnivore)) continue;
        const cellKey = `${org.x},${org.y}`;
        if (cellsWithFights.has(cellKey)) continue;
        const cell = spatialGrid[org.y][org.x];
        const carnivoresInCell = cell.filter(o => o instanceof Carnivore);
        const omnivoresInCell = cell.filter(o => o instanceof Omnivore);
        if (carnivoresInCell.length > 0 && omnivoresInCell.length > 0) {
            const carnivore = carnivoresInCell[0];
            const omnivore = omnivoresInCell[0];
            const carnivorePower = carnivore.energy * carnivore.combatBonus;
            if (carnivorePower >= omnivore.energy) {
                omnivore.die();
                carnivore.energy = Math.min(carnivore.maxEnergy, carnivore.energy + omnivore.energy / 2);
            } else {
                carnivore.die();
                omnivore.energy = Math.min(omnivore.maxEnergy, omnivore.energy + carnivore.energy / 2);
            }
            cellsWithFights.add(cellKey);
        }
    }
    [...organisms].forEach(org => { if (organisms.includes(org)) org.update(); });
    
    time++;
    draw();
    updateStats();
    
    if (time % chartUpdateFrequency === 0) {
        timeHistory.push(time);
        plantHistory.push(organisms.filter(o => o instanceof Plant).length);
        herbivoreHistory.push(organisms.filter(o => o instanceof Herbivore).length);
        carnivoreHistory.push(organisms.filter(o => o instanceof Carnivore).length);
        omnivoreHistory.push(organisms.filter(o => o instanceof Omnivore).length);

        // Keep only last 1000 entries in all histories
        if (timeHistory.length > 1000) {
            timeHistory.splice(0, timeHistory.length - 1000);
            plantHistory.splice(0, plantHistory.length - 1000);
            herbivoreHistory.splice(0, herbivoreHistory.length - 1000);
            carnivoreHistory.splice(0, carnivoreHistory.length - 1000);
            omnivoreHistory.splice(0, omnivoreHistory.length - 1000);
        }

        populationChart.update();
    }

    if (organisms.length === 0) {
        simulationRunning = false;
        clearInterval(simulationInterval);
        startStopBtn.textContent = `Died @ ${formatTime(time)}`;
        startStopBtn.disabled = true;
        startStopBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'bg-teal-500', 'hover:bg-teal-600');
        startStopBtn.classList.add('bg-gray-700', 'cursor-not-allowed');
        copyResultBtn.classList.remove('hidden');
        copySettingsBtn.classList.add('hidden');
        saveSettingsBtn.classList.add('hidden');
    }
}

            function draw() {
                ctx.fillStyle = '#1f2937';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#374151';
                for (let i = 0; i < gridSize; i++) { ctx.beginPath(); ctx.moveTo(i * cellSize, 0); ctx.lineTo(i * cellSize, canvas.height); ctx.moveTo(0, i * cellSize); ctx.lineTo(canvas.width, i * cellSize); ctx.stroke(); }
                organisms.forEach(org => org.draw());
            }

            function updateStats() {
                document.getElementById('timeStat').textContent = formatTime(time);
                document.getElementById('plantStat').textContent = organisms.filter(o => o instanceof Plant).length;
                document.getElementById('herbivoreStat').textContent = organisms.filter(o => o instanceof Herbivore).length;
                document.getElementById('carnivoreStat').textContent = organisms.filter(o => o instanceof Carnivore).length;
                document.getElementById('omnivoreStat').textContent = organisms.filter(o => o instanceof Omnivore).length;
            }

            function resetSimulation() {
                simulationRunning = false;
                startStopBtn.textContent = 'Start';
                startStopBtn.disabled = false;
                startStopBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'bg-gray-700', 'cursor-not-allowed');
                startStopBtn.classList.add('bg-teal-500', 'hover:bg-teal-600');
                copyResultBtn.classList.add('hidden');
                copySettingsBtn.classList.remove('hidden');
                saveSettingsBtn.classList.remove('hidden');
                clearInterval(simulationInterval);
                gridSize = parseInt(gridSizeSlider.value);
                cellSize = canvas.width / gridSize;
                init();
            }

            function resetPopulationSliders() {
                plantSlider.value = 10;
                herbivoreSlider.value = 5;
                carnivoreSlider.value = 1;
                omnivoreSlider.value = 2;
                plantPercentLabel.textContent = 10;
                herbivorePercentLabel.textContent = 5;
                carnivorePercentLabel.textContent = 1;
                omnivorePercentLabel.textContent = 2;
                resetSimulation();
            }
            
            function generateSettingsString(isResult = false) {
                let settingsString = "--- EvolutionBob Settings ---\n\n";
                if(isResult) {
                    settingsString = `--- EvolutionBob Run Result ---\nTime: ${formatTime(time)}\n\n`;
                }
                settingsString += "[Initial Population]\n";
                settingsString += `Plants: ${plantSlider.value}%\n`;
                settingsString += `Herbivores: ${herbivoreSlider.value}%\n`;
                settingsString += `Carnivores: ${carnivoreSlider.value}%\n`;
                settingsString += `Omnivores: ${omnivoreSlider.value}%\n\n`;

                settingsString += "[Advanced Parameters]\n";
                for (const species in config) {
                    settingsString += `[${species.charAt(0).toUpperCase() + species.slice(1)}]\n`;
                    for (const param in config[species]) {
                        const key = param.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        let value = config[species][param];
                         if (param === 'reproduceChance' || param === 'hungerThreshold' || param === 'combatBonus') {
                            value = `${(value * 100 - (param === 'combatBonus' ? 100 : 0)).toFixed(0)}%`;
                        } else if (typeof value === 'number' && !Number.isInteger(value)) {
                            value = value.toFixed(1);
                        }
                        settingsString += `${key}: ${value}\n`;
                    }
                    settingsString += "\n";
                }
                return settingsString;
            }

            function copyToClipboard(text, button) {
                 const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }

            function saveSettingsToFile() {
                const settingsString = generateSettingsString();
                const blob = new Blob([settingsString], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'evolution-bob-settings.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function parseAndApplySettings(text) {
                try {
                    const lines = text.split('\n');
                    let currentSection = null;
                    let currentSpecies = null;
                    
                    const paramMap = {
                        'Max Energy': 'maxEnergy', 'Reproduce Cost': 'reproduceCost', 'Reproduce Chance': 'reproduceChance', 'Energy Gain': 'energyGain', 'Reproduction Energy': 'reproduceEnergy', 'Energy Decay': 'energyDecay', 'Max Age': 'maxAge', 'Search Radius': 'searchRadius', 'Hunger Threshold': 'hungerThreshold', 'Search Cooldown': 'searchCooldown', 'Combat Bonus': 'combatBonus'
                    };
                    const populationMap = { 'Plants': plantSlider, 'Herbivores': herbivoreSlider, 'Carnivores': carnivoreSlider, 'Omnivores': omnivoreSlider };

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('--') || trimmedLine === '') continue;

                        if (trimmedLine === '[Initial Population]') { currentSection = 'population'; continue; }
                        if (trimmedLine === '[Advanced Parameters]') { currentSection = 'advanced'; continue; }

                        if (currentSection === 'population' && trimmedLine.includes(':')) {
                            const [key, value] = trimmedLine.split(/:\s*/);
                            if (populationMap[key]) {
                                populationMap[key].value = parseFloat(value.replace('%', ''));
                            }
                        } else if (currentSection === 'advanced') {
                            if (trimmedLine.startsWith('[') && trimmedLine.endsWith(']')) {
                                const speciesName = trimmedLine.substring(1, trimmedLine.length - 1).toLowerCase();
                                if (config[speciesName]) currentSpecies = speciesName;
                            } else if (currentSpecies && trimmedLine.includes(':')) {
                                const [key, value] = trimmedLine.split(/:\s*/);
                                const paramKey = paramMap[key];
                                if (paramKey && config[currentSpecies][paramKey] !== undefined) {
                                    let parsedValue = parseFloat(value.replace('%', ''));
                                    if (paramKey === 'reproduceChance' || paramKey === 'hungerThreshold') {
                                        config[currentSpecies][paramKey] = parsedValue / 100;
                                    } else if (paramKey === 'combatBonus') {
                                        config[currentSpecies][paramKey] = 1 + (parsedValue / 100);
                                    } else {
                                        config[currentSpecies][paramKey] = parsedValue;
                                    }
                                }
                            }
                        }
                    }
                    updateAdvancedSettingsUI();
                    plantPercentLabel.textContent = plantSlider.value;
                    herbivorePercentLabel.textContent = herbivoreSlider.value;
                    carnivorePercentLabel.textContent = carnivoreSlider.value;
                    omnivorePercentLabel.textContent = omnivoreSlider.value;
                    resetSimulation();
                } catch (error) {
                    console.error("Failed to parse settings file:", error);
                    alert("Could not parse the settings file. Please ensure it is a valid settings file generated by this simulation.");
                }
            }

            function formatTime(num) {
                if (num > 99999) {
                    return num.toExponential(2);
                }
                return num.toString();
            }

            // --- Event Listeners ---
            startStopBtn.addEventListener('click', () => {
                if (startStopBtn.disabled) return;
                simulationRunning = !simulationRunning;
                if (simulationRunning) {
                    startStopBtn.textContent = 'Stop';
                    startStopBtn.classList.replace('bg-teal-500', 'bg-yellow-500');
                    startStopBtn.classList.replace('hover:bg-teal-600', 'hover:bg-yellow-600');
                    simulationInterval = setInterval(simulationStep, speed);
                } else {
                    startStopBtn.textContent = 'Start';
                    startStopBtn.classList.replace('bg-yellow-500', 'bg-teal-500');
                    startStopBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-teal-600');
                    clearInterval(simulationInterval);
                }
            });

            resetBtn.addEventListener('click', resetSimulation);
            resetPopulationBtn.addEventListener('click', resetPopulationSliders);
            resetAdvancedBtn.addEventListener('click', () => {
                setDefaultConfig();
                resetSimulation();
            });
            copySettingsBtn.addEventListener('click', () => copyToClipboard(generateSettingsString(), copySettingsBtn));
            saveSettingsBtn.addEventListener('click', saveSettingsToFile);
            copyResultBtn.addEventListener('click', () => copyToClipboard(generateSettingsString(true), copyResultBtn));
            importSettingsBtn.addEventListener('click', () => settingsFileInput.click());
            settingsFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => parseAndApplySettings(e.target.result);
                    reader.readAsText(file);
                }
            });

            speedSlider.addEventListener('input', (e) => {
                speed = 1001 - parseInt(e.target.value);
                if (simulationRunning) {
                    clearInterval(simulationInterval);
                    simulationInterval = setInterval(simulationStep, speed);
                }
            });

            gridSizeSlider.addEventListener('input', (e) => {
                gridSizeLabel.textContent = e.target.value;
                gridSizeLabel2.textContent = e.target.value;
            });
            gridSizeSlider.addEventListener('change', resetSimulation);

            function setupPopulationSlider(slider, label) {
                slider.addEventListener('input', () => { label.textContent = slider.value; });
                slider.addEventListener('change', resetSimulation);
            }
            setupPopulationSlider(plantSlider, plantPercentLabel);
            setupPopulationSlider(herbivoreSlider, herbivorePercentLabel);
            setupPopulationSlider(carnivoreSlider, carnivorePercentLabel);
            setupPopulationSlider(omnivoreSlider, omnivorePercentLabel);

            function setupAdvancedSlider(input, species, param) {
                 input.addEventListener('input', () => {
                    let value = parseFloat(input.value);
                    if (param === 'reproduceChance' || param === 'hungerThreshold') { config[species][param] = value / 100; }
                    else if (param === 'combatBonus') { config[species][param] = 1 + (value / 100); }
                    else { config[species][param] = value; }
                    updateAdvancedLabels();
                });
                input.addEventListener('change', resetSimulation);
            }

            for (const species in inputs) {
                for (const param in inputs[species]) {
                    setupAdvancedSlider(inputs[species][param], species, param);
                }
            }

            // Tooltip logic
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const gridX = Math.floor(x / cellSize);
                const gridY = Math.floor(y / cellSize);
                if (gridX < 0 || gridX >= gridSize || gridY >= gridSize || y < 0 || !spatialGrid[gridY]) { tooltip.style.display = 'none'; return; }
                let foundOrg = spatialGrid[gridY]?.[gridX]?.find(org => true);
                if (foundOrg && typeof foundOrg.getTooltipInfo === 'function') {
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY + 15}px`;
                    tooltip.textContent = foundOrg.getTooltipInfo();
                } else { tooltip.style.display = 'none'; }
            });
            canvas.addEventListener('mouseout', () => { tooltip.style.display = 'none'; });
            
            window.addEventListener('resize', () => {
                canvasSize = Math.min(document.getElementById('canvas-container').clientWidth, window.innerHeight * 0.8, 800);
                canvas.width = canvasSize;
                canvas.height = canvasSize;
                cellSize = canvas.width / gridSize;
                draw();
            });

            // Initial setup
            setDefaultConfig();
            resetSimulation();
        });
    </script>
</body>
</html>
